#!/bin/bash

# Cloudways PHP 7.4 Compatibility Fix Script
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÑÑ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ ÐµÑÐ»Ð¸ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ PHP 7.4

echo "ðŸ”§ Fixing PHP 7.4 compatibility issues..."

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ PHP
PHP_VERSION=$(php -r "echo PHP_VERSION;")
echo "ðŸ“‹ Current PHP version: $PHP_VERSION"

if [[ "$PHP_VERSION" == 7.4* ]]; then
    echo "âš ï¸  PHP 7.4 detected. Using compatible version..."
    
    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½ÑƒÑŽ ÐºÐ¾Ð¿Ð¸ÑŽ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ composer.json
    if [ -f "composer.json" ]; then
        cp composer.json composer-php82.json
        echo "âœ… Backed up original composer.json"
    fi
    
    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼ÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ composer.json Ð´Ð»Ñ PHP 7.4
    cat > composer.json << 'COMPOSER_EOF'
{
    "$schema": "https://getcomposer.org/schema.json",
    "name": "laravel/laravel",
    "type": "project",
    "description": "The skeleton application for the Laravel framework.",
    "keywords": ["laravel", "framework"],
    "license": "MIT",
    "require": {
        "php": "^7.4|^8.0",
        "laravel/framework": "^9.0",
        "laravel/tinker": "^2.7"
    },
    "require-dev": {
        "fakerphp/faker": "^1.9.1",
        "laravel/pint": "^1.0",
        "laravel/sail": "^1.0.1",
        "mockery/mockery": "^1.4.4",
        "nunomaduro/collision": "^6.0",
        "phpunit/phpunit": "^9.5.10"
    },
    "autoload": {
        "psr-4": {
            "App\\": "app/",
            "Database\\Factories\\": "database/factories/",
            "Database\\Seeders\\": "database/seeders/"
        }
    },
    "autoload-dev": {
        "psr-4": {
            "Tests\\": "tests/"
        }
    },
    "scripts": {
        "post-autoload-dump": [
            "Illuminate\\Foundation\\ComposerScripts::postAutoloadDump",
            "@php artisan package:discover --ansi"
        ],
        "post-update-cmd": [
            "@php artisan vendor:publish --tag=laravel-assets --ansi --force"
        ],
        "post-root-package-install": [
            "@php -r \"file_exists('.env') || copy('.env.example', '.env');\""
        ],
        "post-create-project-cmd": [
            "@php artisan key:generate --ansi",
            "@php -r \"file_exists('database/database.sqlite') || touch('database/database.sqlite');\"",
            "@php artisan migrate --graceful --ansi"
        ],
        "pre-package-uninstall": [
            "Illuminate\\Foundation\\ComposerScripts::prePackageUninstall"
        ]
    },
    "extra": {
        "laravel": {
            "dont-discover": []
        }
    },
    "config": {
        "optimize-autoloader": true,
        "preferred-install": "dist",
        "sort-packages": true,
        "allow-plugins": {
            "pestphp/pest-plugin": true,
            "php-http/discovery": true
        }
    },
    "minimum-stability": "stable",
    "prefer-stable": true
}
COMPOSER_EOF
    
    echo "âœ… Created PHP 7.4 compatible composer.json"
    
    # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
    echo "ðŸ§¹ Removing old dependencies..."
    rm -rf vendor composer.lock
    
    # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
    echo "ðŸ“¦ Installing PHP 7.4 compatible dependencies..."
    composer install --no-dev --optimize-autoloader
    
    if [ $? -eq 0 ]; then
        echo "âœ… Dependencies installed successfully"
    else
        echo "âŒ Failed to install dependencies"
        exit 1
    fi
    
else
    echo "âœ… PHP version is compatible (8.0+)"
    echo "ðŸ“¦ Installing dependencies..."
    composer install --no-dev --optimize-autoloader
fi

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ Ð½ÐµÑ‚
if [ ! -f ".env" ]; then
    echo "ðŸ“ Creating .env file..."
    cp .env.example .env
    echo "âš ï¸  Please configure your .env file with production settings"
fi

# Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ»ÑŽÑ‡ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
echo "ðŸ”‘ Generating application key..."
php artisan key:generate --force

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
echo "ðŸ” Setting permissions..."
chmod -R 755 storage
chmod -R 755 bootstrap/cache

# ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÐºÑÑˆ
echo "ðŸ§¹ Clearing caches..."
php artisan config:clear
php artisan cache:clear
php artisan view:clear
php artisan route:clear

# ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐµÐ½Ð°
echo "âš¡ Optimizing for production..."
php artisan config:cache
php artisan route:cache
php artisan view:cache

echo "âœ… PHP compatibility fix completed!"
echo ""
echo "ðŸ“‹ Next steps:"
echo "1. Configure your .env file with production settings"
echo "2. Set up your database connection"
echo "3. Run 'php artisan migrate' if needed"
echo "4. Check your website at your domain"
echo "5. Monitor logs with 'tail -f storage/logs/laravel.log'"
echo ""
echo "ðŸŒ Your Laravel application should now be running!"
